<?php
/**
 * 📊 DASHBOARD CRM - RE.DE CONSULTING
 * File: /dashboard.php
 * 
 * Dashboard principale con bootstrap integrato
 * CRM Rede Consulting - Versione pulita
 */

// ================================================================
// CARICA BOOTSTRAP (gestisce autenticazione e inizializzazione)
// ================================================================
require_once __DIR__ . '/core/bootstrap.php';

// ================================================================
// CARICA COMPONENTI NECESSARI
// ================================================================
loadDatabase(); // Carica Database se disponibile
loadHelpers();  // Carica helpers se disponibili

/**
 * 🔧 Inizializza dati dashboard
 */
function initializeDashboardData() {
    global $database;
    
    $data = [
        'operators' => ['total_operators' => 0, 'active_operators' => 0, 'online_operators' => 0],
        'sessions' => ['operators_with_sessions' => 0, 'total_active_sessions' => 0],
        'clients' => ['total_clients' => 0, 'active_clients' => 0, 'new_clients_week' => 0],
        'practices' => ['pending_practices' => 0, 'urgent_practices' => 0],
        'tasks' => ['pending_tasks' => 0, 'tasks_today' => 0, 'overdue_tasks' => 0]
    ];
    
    try {
        if (isset($database)) {
            // Statistiche operatori
            $stmt = $database->db->prepare("
                SELECT 
                    COUNT(*) as total_operators,
                    SUM(CASE WHEN is_attivo = 1 THEN 1 ELSE 0 END) as active_operators
                FROM operatori
            ");
            $stmt->execute();
            $result = $stmt->fetch(PDO::FETCH_ASSOC);
            if ($result) {
                $data['operators']['total_operators'] = $result['total_operators'];
                $data['operators']['active_operators'] = $result['active_operators'];
            }
            
            // Statistiche clienti
            $stmt = $database->db->prepare("
                SELECT 
                    COUNT(*) as total_clients,
                    SUM(CASE WHEN is_attivo = 1 THEN 1 ELSE 0 END) as active_clients,
                    SUM(CASE WHEN created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 ELSE 0 END) as new_clients_week
                FROM clienti
            ");
            $stmt->execute();
            $result = $stmt->fetch(PDO::FETCH_ASSOC);
            if ($result) {
                $data['clients'] = $result;
            }
        }
    } catch (Exception $e) {
        error_log("Dashboard data error: " . $e->getMessage());
    }
    
    return $data;
}

/**
 * 📊 Ottieni statistiche rapide per cards
 */
function getQuickStats() {
    $dashboardData = initializeDashboardData();
    
    return [
        [
            'title' => 'Operatori Attivi',
            'value' => $dashboardData['operators']['active_operators'],
            'total' => $dashboardData['operators']['total_operators'],
            'icon' => '👥',
            'color' => 'primary',
            'link' => '?action=operatori'
        ],
        [
            'title' => 'Clienti Attivi',
            'value' => $dashboardData['clients']['active_clients'],
            'total' => $dashboardData['clients']['total_clients'],
            'icon' => '🏢',
            'color' => 'success',
            'link' => '?action=clienti'
        ],
        [
            'title' => 'Nuovi Clienti',
            'value' => $dashboardData['clients']['new_clients_week'],
            'subtitle' => 'Ultimi 7 giorni',
            'icon' => '📈',
            'color' => 'info',
            'link' => '?action=clienti&filter=new'
        ],
        [
            'title' => 'Attività Oggi',
            'value' => 0,
            'subtitle' => 'Da completare',
            'icon' => '📋',
            'color' => 'warning',
            'link' => '?action=tasks'
        ]
    ];
}

/**
 * 🚨 Ottieni alert critici
 */
function getCriticalAlerts() {
    return [];
}

// ================================================================
// ESECUZIONE PRINCIPALE DASHBOARD
// ================================================================

try {
    $stats_cards = getQuickStats();
    $criticalAlerts = getCriticalAlerts();
    $user = getCurrentUser();
    
    $page_title = 'Dashboard - CRM Re.De Consulting';
    $last_updated = date('H:i:s');
    
} catch (Exception $e) {
    error_log("Dashboard execution error: " . $e->getMessage());
    $stats_cards = [];
    $criticalAlerts = [];
    $user = ['nome' => 'Utente'];
}
?>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $page_title ?></title>
    
    <!-- CSS Esistenti -->
    <link rel="stylesheet" href="assets/css/datev-style.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    
    <style>
    /* CSS Dashboard Integrato */
    :root {
        --primary: #007849;
        --primary-dark: #005a37;
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        background: #f5f7f9;
        min-height: 100vh;
    }

    .dashboard-header {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .welcome-section h1 {
        color: var(--primary);
        margin: 0;
        font-size: 28px;
    }

    .welcome-section p {
        color: #6c757d;
        margin: 4px 0 0 0;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn-outline:hover {
        background: var(--primary);
        color: white;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.3s;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .stat-icon {
        font-size: 32px;
        line-height: 1;
    }

    .stat-value {
        font-size: 36px;
        font-weight: bold;
        line-height: 1;
        margin-bottom: 8px;
    }

    .stat-title {
        color: #6c757d;
        font-size: 14px;
        font-weight: 500;
    }

    .stat-subtitle {
        color: #adb5bd;
        font-size: 12px;
        margin-top: 4px;
    }

    /* Alert System */
    .alerts-section {
        margin-bottom: 24px;
    }

    .alert {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Main Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
    }

    .content-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 24px;
    }

    .content-card h2 {
        margin: 0 0 20px 0;
        color: var(--primary);
        font-size: 20px;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        gap: 12px;
    }

    .action-item {
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s;
    }

    .action-item:hover {
        background: #e9ecef;
    }

    /* Recent Activities */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .activity-item {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 14px;
    }

    .activity-time {
        color: #6c757d;
        font-size: 12px;
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="welcome-section">
                <h1>Benvenuto, <?= htmlspecialchars($user['nome'] ?? 'Utente') ?>!</h1>
                <p>Ultimo aggiornamento: <?= $last_updated ?></p>
            </div>
            <div class="header-actions">
                <a href="?action=clienti&view=create" class="btn btn-primary">
                    ➕ Nuovo Cliente
                </a>
                <a href="?action=operatori" class="btn btn-outline">
                    👥 Operatori
                </a>
                <a href="?action=logout" class="btn btn-outline">
                    🚪 Esci
                </a>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <?php foreach ($stats_cards as $stat): ?>
                <a href="<?= htmlspecialchars($stat['link']) ?>" class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">
                                <?= htmlspecialchars($stat['value']) ?>
                                <?php if (isset($stat['total'])): ?>
                                    <span style="font-size: 18px; color: #6c757d;">
                                        / <?= htmlspecialchars($stat['total']) ?>
                                    </span>
                                <?php endif; ?>
                            </div>
                            <div class="stat-title"><?= htmlspecialchars($stat['title']) ?></div>
                            <?php if (isset($stat['subtitle'])): ?>
                                <div class="stat-subtitle"><?= htmlspecialchars($stat['subtitle']) ?></div>
                            <?php endif; ?>
                        </div>
                        <div class="stat-icon"><?= $stat['icon'] ?></div>
                    </div>
                </a>
            <?php endforeach; ?>
        </div>

        <!-- Alerts -->
        <?php if (!empty($criticalAlerts)): ?>
            <div class="alerts-section">
                <?php foreach ($criticalAlerts as $alert): ?>
                    <div class="alert alert-<?= htmlspecialchars($alert['type']) ?>">
                        <strong><?= htmlspecialchars($alert['title']) ?>:</strong>
                        <?= htmlspecialchars($alert['message']) ?>
                        <?php if (isset($alert['action'])): ?>
                            <a href="<?= htmlspecialchars($alert['action']) ?>" style="margin-left: auto;">
                                Visualizza →
                            </a>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>

        <!-- Main Content -->
        <div class="content-grid">
            <!-- Recent Activities -->
            <div class="content-card">
                <h2>📊 Attività Recenti</h2>
                <div class="activity-list">
                    <div class="activity-item">
                        <div>🆕 Nuovo cliente registrato: Esempio SRL</div>
                        <div class="activity-time">2 ore fa</div>
                    </div>
                    <div class="activity-item">
                        <div>📋 Pratica completata per Cliente ABC</div>
                        <div class="activity-time">4 ore fa</div>
                    </div>
                    <div class="activity-item">
                        <div>📧 Email inviata a 15 clienti</div>
                        <div class="activity-time">Ieri alle 18:30</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="content-card">
                <h2>⚡ Azioni Rapide</h2>
                <div class="quick-actions">
                    <a href="?action=clienti" class="action-item">
                        <span>🏢 Gestione Clienti</span>
                        <span>→</span>
                    </a>
                    <a href="?action=operatori" class="action-item">
                        <span>👥 Gestione Operatori</span>
                        <span>→</span>
                    </a>
                    <a href="?action=pratiche" class="action-item">
                        <span>📁 Pratiche in Corso</span>
                        <span>→</span>
                    </a>
                    <a href="?action=scadenze" class="action-item">
                        <span>📅 Scadenzario</span>
                        <span>→</span>
                    </a>
                    <a href="?action=reports" class="action-item">
                        <span>📊 Report e Statistiche</span>
                        <span>→</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript per microinterazioni -->
    <script>
        // Auto-refresh dashboard ogni 5 minuti
        setTimeout(() => {
            location.reload();
        }, 300000);

        // Animazione contatori
        document.querySelectorAll('.stat-value').forEach(element => {
            const value = parseInt(element.textContent);
            if (!isNaN(value)) {
                let current = 0;
                const increment = value / 20;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= value) {
                        current = value;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 50);
            }
        });
    </script>
</body>
</html>