<?php
/**
 * modules/operatori/create.php - Creazione Operatore CRM Re.De Consulting
 * 
 * Form completo per la creazione di nuovi operatori con:
 * - Validazione avanzata lato client e server
 * - Gestione qualifiche multiple
 * - Configurazione orari di lavoro
 * - Generazione password sicura
 */

// Avvia sessione se non gi√† attiva
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Percorsi assoluti per evitare problemi
require_once $_SERVER['DOCUMENT_ROOT'] . '/crm/core/classes/Database.php';
require_once $_SERVER['DOCUMENT_ROOT'] . '/crm/core/auth/AuthSystem.php';
require_once $_SERVER['DOCUMENT_ROOT'] . '/crm/core/functions/helpers.php';



// Verifica autenticazione e permessi admin
if (!AuthSystem::isAuthenticated()) {
    header('Location: /crm/core/auth/login.php');
    exit;
}

$sessionInfo = AuthSystem::getSessionInfo();
if (!$sessionInfo['is_admin']) {
    header('Location: /crm/modules/operatori/?error=permissions');
    exit;
}

$db = Database::getInstance();

// Qualifiche predefinite disponibili
$qualificheDisponibili = [
    'Contabilit√† Generale',
    'Bilanci',
    'Dichiarazioni IRPEF',
    'Dichiarazioni IRES',
    'Liquidazioni IVA',
    'F24 e Versamenti',
    'Consulenza Fiscale',
    'Consulenza del Lavoro',
    'Pratiche INPS',
    'Pratiche Camera di Commercio',
    'Contrattualistica',
    'Amministrazione Condominiali',
    'Gestione Clienti',
    'Formazione e Supporto'
];

// Gestione form submission
$errors = [];
$success = false;

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        // Sanitizzazione e validazione input
        $cognome = trim($_POST['cognome'] ?? '');
        $nome = trim($_POST['nome'] ?? '');
        $email = trim($_POST['email'] ?? '');
        $qualifiche = $_POST['qualifiche'] ?? [];
        $tipoContratto = $_POST['tipo_contratto'] ?? '';
        $isAmministratore = isset($_POST['is_amministratore']) ? 1 : 0;
        $isAttivo = isset($_POST['is_attivo']) ? 1 : 0;
        
        // Orari di lavoro
        $orarioMattinoInizio = $_POST['orario_mattino_inizio'] ?? null;
        $orarioMattinoFine = $_POST['orario_mattino_fine'] ?? null;
        $orarioPomeriggioInizio = $_POST['orario_pomeriggio_inizio'] ?? null;
        $orarioPomeriggioFine = $_POST['orario_pomeriggio_fine'] ?? null;
        $orarioContinuatoInizio = $_POST['orario_continuato_inizio'] ?? null;
        $orarioContinuatoFine = $_POST['orario_continuato_fine'] ?? null;
        
        // Validazioni
        if (empty($cognome)) $errors[] = 'Il cognome √® obbligatorio';
        if (empty($nome)) $errors[] = 'Il nome √® obbligatorio';
        if (empty($email)) $errors[] = 'L\'email √® obbligatoria';
        if (!validateEmail($email)) $errors[] = 'Email non valida';
        if (empty($qualifiche)) $errors[] = 'Seleziona almeno una qualifica';
        if (!in_array($tipoContratto, ['spezzato', 'continuato'])) $errors[] = 'Tipo contratto non valido';
        
        // Verifica email univoca
        if (!empty($email)) {
            $existingOperator = $db->selectOne("SELECT id FROM operatori WHERE email = ?", [$email]);
            if ($existingOperator) {
                $errors[] = 'Email gi√† utilizzata da un altro operatore';
            }
        }
        
        // Validazione orari
        if ($tipoContratto === 'spezzato') {
            if (empty($orarioMattinoInizio) || empty($orarioMattinoFine)) {
                $errors[] = 'Orario mattino obbligatorio per contratto spezzato';
            }
            if (empty($orarioPomeriggioInizio) || empty($orarioPomeriggioFine)) {
                $errors[] = 'Orario pomeriggio obbligatorio per contratto spezzato';
            }
        } else {
            if (empty($orarioContinuatoInizio) || empty($orarioContinuatoFine)) {
                $errors[] = 'Orario continuato obbligatorio per questo tipo di contratto';
            }
        }
        
        // Se nessun errore, procedi con l'inserimento
        if (empty($errors)) {
            // Genera password temporanea sicura
            $passwordTemp = 'Temp' . rand(1000, 9999) . '!';
            $passwordHash = password_hash($passwordTemp, PASSWORD_DEFAULT);
            
            // Prepara qualifiche come JSON
            $qualificheJson = json_encode($qualifiche);
            
            // Inserisci operatore
            $operatoreId = $db->insert(
                "INSERT INTO operatori (
                    cognome, nome, email, password_hash, qualifiche, 
                    tipo_contratto, 
                    orario_mattino_inizio, orario_mattino_fine,
                    orario_pomeriggio_inizio, orario_pomeriggio_fine,
                    orario_continuato_inizio, orario_continuato_fine,
                    is_amministratore, is_attivo
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
                [
                    $cognome, $nome, $email, $passwordHash, $qualificheJson,
                    $tipoContratto,
                    $tipoContratto === 'spezzato' ? $orarioMattinoInizio : null,
                    $tipoContratto === 'spezzato' ? $orarioMattinoFine : null,
                    $tipoContratto === 'spezzato' ? $orarioPomeriggioInizio : null,
                    $tipoContratto === 'spezzato' ? $orarioPomeriggioFine : null,
                    $tipoContratto === 'continuato' ? $orarioContinuatoInizio : null,
                    $tipoContratto === 'continuato' ? $orarioContinuatoFine : null,
                    $isAmministratore,
                    $isAttivo
                ]
            );
            
            if ($operatoreId) {
                $success = true;
                $successMessage = "Operatore creato con successo! Password temporanea: <strong>$passwordTemp</strong>";
                
                // Log dell'azione
                error_log("Nuovo operatore creato: ID $operatoreId da admin " . $sessionInfo['operatore_id']);
                
                // Reset form dopo successo
                if (isset($_POST['redirect_after'])) {
                    header("Location: index.php?success=created&id=$operatoreId");
                    exit;
                }
            }
        }
        
    } catch (Exception $e) {
        $errors[] = 'Errore durante la creazione: ' . $e->getMessage();
        error_log("Errore creazione operatore: " . $e->getMessage());
    }
}
?>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuovo Operatore - CRM Re.De Consulting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/datev-style.css">
    <link rel="stylesheet" href="../../assets/css/responsive.css">
    <style>
        /* Stili specifici per form creazione */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-row {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-row.two-cols {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-row.three-cols {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .qualifiche-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .qualifica-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 2px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .qualifica-item:hover {
            background: var(--green-50);
            border-color: var(--green-200);
        }
        
        .qualifica-item input[type="checkbox"] {
            margin: 0;
            accent-color: var(--primary-green);
        }
        
        .qualifica-item.checked {
            background: var(--green-100);
            border-color: var(--primary-green);
        }
        
        .orari-container {
            display: grid;
            gap: 1.5rem;
        }
        
        .orario-group {
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 2px solid var(--gray-200);
        }
        
        .orario-group.active {
            background: var(--green-50);
            border-color: var(--primary-green);
        }
        
        .orario-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: end;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: var(--transition-fast);
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-green);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .password-info {
            background: var(--accent-orange);
            color: white;
            padding: 1rem;
            border-radius: var(--radius-lg);
            margin-top: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .form-actions .left {
            display: flex;
            gap: 1rem;
        }
        
        .form-actions .right {
            display: flex;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .form-row.two-cols,
            .form-row.three-cols {
                grid-template-columns: 1fr;
            }
            
            .qualifiche-grid {
                grid-template-columns: 1fr;
            }
            
            .time-inputs {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .left,
            .form-actions .right {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">R</div>
                    <span>CRM Re.De</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <div class="nav-item">
                        <a href="/crm/dashboard.php" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Gestione</div>
                    <div class="nav-item">
                        <a href="/crm/modules/operatori/" class="nav-link active">
                            <span class="nav-icon">üë•</span>
                            <span>Operatori</span>
                            <span class="nav-badge">Admin</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <button class="sidebar-toggle" type="button">
                        <span style="font-size: 1.25rem;">‚ò∞</span>
                    </button>
                    <h1 class="page-title">Nuovo Operatore</h1>
                </div>
                
                <div class="header-right">
                    <!-- Timer Lavoro -->
                    <div class="work-timer work-timer-display">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span class="time-display">00:00:00</span>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="user-menu">
                        <div class="user-avatar" data-tooltip="<?= htmlspecialchars($sessionInfo['nome_completo']) ?>">
                            <?= substr($sessionInfo['nome_completo'], 0, 1) ?>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <div style="padding: 2rem;">
                <!-- Breadcrumb -->
                <div style="margin-bottom: 2rem;">
                    <nav style="color: var(--gray-500); font-size: var(--font-size-sm);">
                        <a href="/crm/dashboard.php" style="color: var(--gray-500); text-decoration: none;">Dashboard</a>
                        <span> > </span>
                        <a href="/crm/modules/operatori/" style="color: var(--gray-500); text-decoration: none;">Operatori</a>
                        <span> > </span>
                        <span style="color: var(--gray-800); font-weight: 500;">Nuovo Operatore</span>
                    </nav>
                </div>
                
                <div class="form-container">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--gray-800); margin-bottom: 0.5rem;">
                            üë§ Nuovo Operatore
                        </h2>
                        <p style="color: var(--gray-500);">
                            Compila tutti i campi per creare un nuovo operatore
                        </p>
                    </div>
                    
                    <!-- Messaggi di errore/successo -->
                    <?php if (!empty($errors)): ?>
                        <div class="card" style="background: var(--danger-red); color: white; margin-bottom: 2rem;">
                            <div class="card-body">
                                <h4 style="color: white; margin-bottom: 1rem;">‚ùå Errori di Validazione</h4>
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <?php foreach ($errors as $error): ?>
                                        <li><?= htmlspecialchars($error) ?></li>
                                    <?php endforeach; ?>
                                </ul>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <?php if ($success): ?>
                        <div class="card" style="background: var(--secondary-green); color: white; margin-bottom: 2rem;">
                            <div class="card-body">
                                <h4 style="color: white; margin-bottom: 1rem;">‚úÖ Operatore Creato</h4>
                                <p style="margin: 0;"><?= $successMessage ?></p>
                                <div style="margin-top: 1rem;">
                                    <a href="index.php" class="btn" style="background: white; color: var(--secondary-green);">
                                        ‚Üê Torna alla Lista
                                    </a>
                                    <button onclick="window.print()" class="btn" style="background: rgba(255,255,255,0.2); color: white;">
                                        üñ®Ô∏è Stampa Credenziali
                                    </button>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <!-- Form -->
                    <form method="POST" id="operatorForm" novalidate>
                        <!-- Dati Anagrafici -->
                        <div class="form-section">
                            <h3 class="section-title">
                                üë§ Dati Anagrafici
                            </h3>
                            
                            <div class="form-row two-cols">
                                <div class="form-group">
                                    <label class="form-label" for="cognome">
                                        Cognome <span style="color: var(--danger-red);">*</span>
                                    </label>
                                    <input type="text" 
                                           id="cognome" 
                                           name="cognome" 
                                           class="form-control" 
                                           value="<?= htmlspecialchars($_POST['cognome'] ?? '') ?>"
                                           required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="nome">
                                        Nome <span style="color: var(--danger-red);">*</span>
                                    </label>
                                    <input type="text" 
                                           id="nome" 
                                           name="nome" 
                                           class="form-control" 
                                           value="<?= htmlspecialchars($_POST['nome'] ?? '') ?>"
                                           required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="email">
                                    Email <span style="color: var(--danger-red);">*</span>
                                </label>
                                <input type="email" 
                                       id="email" 
                                       name="email" 
                                       class="form-control" 
                                       value="<?= htmlspecialchars($_POST['email'] ?? '') ?>"
                                       placeholder="operatore@redeconsulting.eu"
                                       required>
                                <small style="color: var(--gray-500); font-size: var(--font-size-xs);">
                                    Verr√† utilizzata per il login. Deve essere univoca.
                                </small>
                            </div>
                        </div>
                        
                        <!-- Qualifiche -->
                        <div class="form-section">
                            <h3 class="section-title">
                                üéì Qualifiche e Competenze
                            </h3>
                            
                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                Seleziona le qualifiche e competenze dell'operatore:
                            </p>
                            
                            <div class="qualifiche-grid">
                                <?php foreach ($qualificheDisponibili as $qualifica): ?>
                                    <label class="qualifica-item">
                                        <input type="checkbox" 
                                               name="qualifiche[]" 
                                               value="<?= htmlspecialchars($qualifica) ?>"
                                               <?= in_array($qualifica, $_POST['qualifiche'] ?? []) ? 'checked' : '' ?>>
                                        <span><?= htmlspecialchars($qualifica) ?></span>
                                    </label>
                                <?php endforeach; ?>
                            </div>
                        </div>
                        
                        <!-- Configurazione Contratto -->
                        <div class="form-section">
                            <h3 class="section-title">
                                üìã Configurazione Contratto
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="tipo_contratto">
                                        Tipo Contratto <span style="color: var(--danger-red);">*</span>
                                    </label>
                                    <select id="tipo_contratto" name="tipo_contratto" class="form-control" required>
                                        <option value="">Seleziona tipo contratto</option>
                                        <option value="continuato" <?= ($_POST['tipo_contratto'] ?? '') === 'continuato' ? 'selected' : '' ?>>
                                            Orario Continuato
                                        </option>
                                        <option value="spezzato" <?= ($_POST['tipo_contratto'] ?? '') === 'spezzato' ? 'selected' : '' ?>>
                                            Orario Spezzato (Mattino + Pomeriggio)
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Orari di Lavoro -->
                            <div class="orari-container">
                                <!-- Orario Continuato -->
                                <div class="orario-group" id="orario-continuato" style="display: none;">
                                    <h4 class="orario-title">‚è∞ Orario Continuato</h4>
                                    <div class="time-inputs">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Inizio</label>
                                            <input type="time" 
                                                   name="orario_continuato_inizio" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_continuato_inizio'] ?? '09:00') ?>">
                                        </div>
                                        
                                        <div style="text-align: center; color: var(--gray-500); font-weight: 500;">
                                            alle
                                        </div>
                                        
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Fine</label>
                                            <input type="time" 
                                                   name="orario_continuato_fine" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_continuato_fine'] ?? '18:00') ?>">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Orario Spezzato -->
                                <div class="orario-group" id="orario-spezzato" style="display: none;">
                                    <h4 class="orario-title">üåÖ Orario Mattino</h4>
                                    <div class="time-inputs">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Inizio</label>
                                            <input type="time" 
                                                   name="orario_mattino_inizio" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_mattino_inizio'] ?? '09:00') ?>">
                                        </div>
                                        
                                        <div style="text-align: center; color: var(--gray-500); font-weight: 500;">
                                            alle
                                        </div>
                                        
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Fine</label>
                                            <input type="time" 
                                                   name="orario_mattino_fine" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_mattino_fine'] ?? '13:00') ?>">
                                        </div>
                                    </div>
                                    
                                    <h4 class="orario-title" style="margin-top: 1.5rem;">üåá Orario Pomeriggio</h4>
                                    <div class="time-inputs">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Inizio</label>
                                            <input type="time" 
                                                   name="orario_pomeriggio_inizio" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_pomeriggio_inizio'] ?? '14:00') ?>">
                                        </div>
                                        
                                        <div style="text-align: center; color: var(--gray-500); font-weight: 500;">
                                            alle
                                        </div>
                                        
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label class="form-label">Fine</label>
                                            <input type="time" 
                                                   name="orario_pomeriggio_fine" 
                                                   class="form-control"
                                                   value="<?= htmlspecialchars($_POST['orario_pomeriggio_fine'] ?? '18:00') ?>">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Permessi e Stato -->
                        <div class="form-section">
                            <h3 class="section-title">
                                üîê Permessi e Stato
                            </h3>
                            
                            <div class="form-row two-cols">
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" 
                                               name="is_amministratore" 
                                               id="is_amministratore"
                                               <?= isset($_POST['is_amministratore']) ? 'checked' : '' ?>>
                                        <span class="slider"></span>
                                    </label>
                                    <div>
                                        <strong>Amministratore</strong>
                                        <div style="color: var(--gray-500); font-size: var(--font-size-sm);">
                                            Accesso completo al sistema
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" 
                                               name="is_attivo" 
                                               id="is_attivo"
                                               <?= !isset($_POST['is_attivo']) || $_POST['is_attivo'] ? 'checked' : '' ?>>
                                        <span class="slider"></span>
                                    </label>
                                    <div>
                                        <strong>Operatore Attivo</strong>
                                        <div style="color: var(--gray-500); font-size: var(--font-size-sm);">
                                            Pu√≤ effettuare il login
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Password Info -->
                        <div class="password-info">
                            <h4 style="color: white; margin-bottom: 0.5rem;">üîë Password Temporanea</h4>
                            <p style="margin: 0; opacity: 0.9;">
                                Verr√† generata automaticamente una password temporanea che l'operatore dovr√† cambiare al primo accesso.
                            </p>
                        </div>
                        
                        <!-- Azioni Form -->
                        <div class="form-actions">
                            <div class="left">
                                <a href="index.php" class="btn btn-secondary">
                                    ‚Üê Annulla
                                </a>
                            </div>
                            
                            <div class="right">
                                <button type="submit" name="redirect_after" value="1" class="btn btn-secondary">
                                    üíæ Salva e Torna alla Lista
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    ‚úÖ Crea Operatore
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="../../assets/js/microinteractions.js"></script>
    <script>
        // Gestione cambio tipo contratto
        document.getElementById('tipo_contratto').addEventListener('change', function() {
            const continuato = document.getElementById('orario-continuato');
            const spezzato = document.getElementById('orario-spezzato');
            
            if (this.value === 'continuato') {
                continuato.style.display = 'block';
                continuato.classList.add('active');
                spezzato.style.display = 'none';
                spezzato.classList.remove('active');
            } else if (this.value === 'spezzato') {
                spezzato.style.display = 'block';
                spezzato.classList.add('active');
                continuato.style.display = 'none';
                continuato.classList.remove('active');
            } else {
                continuato.style.display = 'none';
                spezzato.style.display = 'none';
                continuato.classList.remove('active');
                spezzato.classList.remove('active');
            }
        });
        
        // Trigger iniziale per mostrare orari se gi√† selezionato
        document.getElementById('tipo_contratto').dispatchEvent(new Event('change'));
        
        // Gestione selezione qualifiche
        document.querySelectorAll('.qualifica-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const item = this.closest('.qualifica-item');
                if (this.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
            
            // Trigger iniziale
            if (checkbox.checked) {
                checkbox.closest('.qualifica-item').classList.add('checked');
            }
        });
        
        // Click su label qualifica
        document.querySelectorAll('.qualifica-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
        
        // Validazione form avanzata
        document.getElementById('operatorForm').addEventListener('submit', function(e) {
            const errors = [];
            
            // Validazione qualifiche
            const qualifiche = document.querySelectorAll('input[name="qualifiche[]"]:checked');
            if (qualifiche.length === 0) {
                errors.push('Seleziona almeno una qualifica');
            }
            
            // Validazione orari
            const tipoContratto = document.getElementById('tipo_contratto').value;
            if (tipoContratto === 'continuato') {
                const inizio = document.querySelector('input[name="orario_continuato_inizio"]').value;
                const fine = document.querySelector('input[name="orario_continuato_fine"]').value;
                
                if (!inizio || !fine) {
                    errors.push('Orario continuato incompleto');
                } else if (inizio >= fine) {
                    errors.push('Orario di inizio deve essere precedente a quello di fine');
                }
            } else if (tipoContratto === 'spezzato') {
                const mattinoInizio = document.querySelector('input[name="orario_mattino_inizio"]').value;
                const mattinoFine = document.querySelector('input[name="orario_mattino_fine"]').value;
                const pomeriggioInizio = document.querySelector('input[name="orario_pomeriggio_inizio"]').value;
                const pomeriggioFine = document.querySelector('input[name="orario_pomeriggio_fine"]').value;
                
                if (!mattinoInizio || !mattinoFine || !pomeriggioInizio || !pomeriggioFine) {
                    errors.push('Orari spezzati incompleti');
                } else {
                    if (mattinoInizio >= mattinoFine) {
                        errors.push('Orario mattino non valido');
                    }
                    if (pomeriggioInizio >= pomeriggioFine) {
                        errors.push('Orario pomeriggio non valido');
                    }
                    if (mattinoFine >= pomeriggioInizio) {
                        errors.push('Pausa pranzo insufficiente');
                    }
                }
            }
            
            if (errors.length > 0) {
                e.preventDefault();
                
                if (crmInteractions) {
                    crmInteractions.showModal('Errori di Validazione', `
                        <ul style="margin: 1rem 0; padding-left: 1.5rem; color: var(--danger-red);">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="crmInteractions.closeModal(document.querySelector('.modal-overlay'))">
                                OK
                            </button>
                        </div>
                    `);
                }
            }
        });
        
        // Auto-generazione email da nome/cognome
        document.getElementById('nome').addEventListener('input', generateEmail);
        document.getElementById('cognome').addEventListener('input', generateEmail);
        
        function generateEmail() {
            const nome = document.getElementById('nome').value.trim().toLowerCase();
            const cognome = document.getElementById('cognome').value.trim().toLowerCase();
            const emailField = document.getElementById('email');
            
            if (nome && cognome && !emailField.value) {
                emailField.value = `${nome}.${cognome}@redeconsulting.eu`;
            }
        }
        
        // Conferma prima di lasciare la pagina se ci sono modifiche
        let formChanged = false;
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('change', () => formChanged = true);
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (formChanged && !document.querySelector('.success')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>